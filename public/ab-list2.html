<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
        integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <title>views</title>
</head>

<body>
    <nav class="navbar navbar-expand-lg bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Navbar</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Link</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            Dropdown
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#">Action</a></li>
                            <li><a class="dropdown-item" href="#">Another action</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="#">Something else here</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled">Disabled</a>
                    </li>
                </ul>

            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-lg-4"></div>
            <div class="col-lg-4"></div>
            <div class="col-lg-4">
                <form class="d-flex" role="search" onsubmit="doSearch(event)">
                    <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search"
                        name="search" value="">
                    <button class="btn btn-outline-success" type="submit">Search</button>
                </form>
            </div>
        </div>
        <div class="row">
            <div class="col pagi-container">
                <!-- <nav aria-label="Page navigation example">
                    <ul class="pagination">
                        <li class="page-item disabled"><a class="page-link" href="?page=0"><i
                                    class="fa-solid fa-circle-left"></i></a></li>

                        <li class="page-item"><a class="page-link" href="?page=1">
                                1
                            </a></li>

                        <li class="page-item"><a class="page-link" href="?page=2">
                                2
                            </a></li>

                        <li class="page-item"><a class="page-link" href="?page=3">
                                3
                            </a></li>

                        <li class="page-item"><a class="page-link" href="?page=4">
                                4
                            </a></li>

                        <li class="page-item"><a class="page-link" href="?page=5">
                                5
                            </a></li>

                        <li class="page-item"><a class="page-link" href="?page=6">
                                6
                            </a></li>

                        <li class="page-item "><a class="page-link" href="?page=2">
                                <i class="fa-solid fa-circle-right"></i></a></li>
                    </ul>
                </nav> -->
            </div>
        </div>

        <div class="row">
            <div class="col table-container">
                <!-- <table class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">姓名</th>
                                <th scope="col">手機</th>
                                <th scope="col">email</th>
                                <th scope="col">生日</th>
                                <th scope="col">地址</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td scope="col">1</td>
                                <td scope="col">2</td>
                                <td scope="col">3</td>
                                <td scope="col">4</td>
                                <td scope="col">5</td>
                                <td scope="col">6</td>
                            </tr>
                        </tbody>
                        
                    </table> -->
            </div>
        </div>


    </div>

    <script src="/js/bootstrap.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.5/dayjs.min.js"></script>
    <script>
        const t_container = document.querySelector('.table-container');
        const p_container = document.querySelector('.pagi-container');

        function renderPagi({ page, totalPages }) {
            return `
            <nav aria-label="Page navigation example">
                    <ul class="pagination">
                        <li class="page-item "><a class="page-link" href="#">
                            <i class="fa-solid fa-circle-left"></i></a></li>

                            ${Array(11).fill(1).map((el, i) => {
                const p = page - 5 + i;
                if (p < 1 || p > totalPages) return '';
                return `
                        <li class="page-item ${p === page ? 'active' : ''}"> 
                            <a class="page-link" href="javascript:gotoPage(${p})">
                                ${p}
                            </a></li>
                                    `
            }).join('')
                }
                        

                        <li class="page-item "><a class="page-link" href="#">
                                <i class="fa-solid fa-circle-right"></i></a></li>
                    </ul>
                </nav>
        `;
        };



        function renderTable({ rows }) {
            return `
                <table class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">姓名</th>
                                <th scope="col">手機</th>
                                <th scope="col">email</th>
                                <th scope="col">生日</th>
                                <th scope="col">地址</th>
                            </tr>
                        </thead>
                            <tbody>
                            ${rows.map(el => {
                return `
                                <tr>
                                <td>${el.sid}</td>
                                <td>${el.name}</td>
                                <td>${el.mobile}</td>
                                <td>${el.email}</td>
                                <td>${dayjs(el.birthday).format('YYYY-MM-DD')}</td>
                                <td>${el.address}</td>
                            </tr>`;
            }).join('')}
                            
                            </tbody>
                        
                    </table>
                `;
        }
        /*const search = location.search;
        fetch('/ab/api' + search)
            .then(r => r.json())
            .then(result => {
                console.log(result);
                t_container.innerHTML = renderTable(result);
                p_container.innerHTML = renderPagi(result);
            });*/

        async function getData() {
            //getData(params = null)
            //params:{page:1, search:'abc'}

            let usp = new URLSearchParams(location.search);
            const r = await fetch('http://192.168.35.200:3001/ab/api?' + usp.toString());
            const result = await r.json();
            console.log(result);
            t_container.innerHTML = renderTable(result);
            p_container.innerHTML = renderPagi(result);
        }


        const usp = new URLSearchParams(location.search);
        if (usp.get('search')) document.forms[0].search.value = usp.get('search');
        getData();

        function doSearch(event) {
            event.preventDefault();//不讓表單送出
            const f = event.currentTarget;
            //console.log({ search: f.search.value });

            const usp = new URLSearchParams({ search: f.search.value });

            history.pushState('', '', '?' + usp.toString());
            //console.log(location.search);

            /* fetch('/ab/api' + location.search)
                .then(r => r.json())
                .then(result => {
                    console.log(result);
                    t_container.innerHTML = renderTable(result);
                    p_container.innerHTML = renderPagi(result);
                }); */
            getData();
        }

        function gotoPage(p) {
            const usp = new URLSearchParams(location.search);
            usp.set('page', p);//改寫

            history.pushState('', '', '?' + usp.toString());

            //console.log(location.search);

            /*fetch('/ab/api' + location.search)
                .then(r => r.json())
                .then(result => {
                    console.log(result);
                    t_container.innerHTML = renderTable(result);
                    p_container.innerHTML = renderPagi(result);
                });*/

            getData();
        }

        window.addEventListener('popstate', function () {
            getData();
        });


    </script>

</body>

</html>